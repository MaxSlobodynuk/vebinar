window.SPM_INIT=function(){if(window.SPH.initialized)return;window.SPH.initialized=!0;let e=new class{constructor(e){this.values={http:{get:"GET"},targets:{none:"none",classes:"classes",identifier:"identifier"},triggers:{click:"click",follow:"follow",custom:"custom",pageView:"pageView",videoPlay:"videoPlay",formSubmit:"formSubmit",videoPaused:"videoPaused",videoWatched:"videoWatched"},user:{name:this.getScopeVariable(e,"cookieName","ssId"),query:this.getScopeVariable(e,"queryParameter","ssId"),expireYears:this.getScopeVariable(e,"cookieExpireYears",10)},timeout:this.getScopeVariable(e,"timeout",3e3),identifier:this.getScopeVariable(e,"identifier",null),baseUrl:this.getScopeVariable(e,"baseUrl","https://customer.smartsender.eu/pixel")}}getValue(e){return this.values[e]}getHttpValue(e){return this.values.http[e]}getUserValue(e){return this.values.user[e]}getTargetValue(e){return this.values.targets[e]}getTriggerValue(e){return this.values.triggers[e]}getScopeVariable(e,t,i){return e&&e[t]||i}}(window.SPH),t=new class{constructor(e){this.config=e}getQueryParameter(e){let t=new URL(window.location);return new URLSearchParams(t.search).get(e)||null}sendRequest(t,i,s,r){let a=new XMLHttpRequest;a.open(i,e.getValue("baseUrl")+t+"?"+this.buildQuery({au:this.config.getValue("identifier"),dl:window.location.href})),i!==this.config.getHttpValue("get")&&a.setRequestHeader("Content-type","application/json"),a.setRequestHeader("X-Requested-With","XMLHttpRequest"),a.onreadystatechange=function(){4===this.readyState&&200===this.status&&r(JSON.parse(this.responseText))};let n=JSON.stringify({cxt:{...this.getQuery(),...s}});a.send(n)}getQuery(){const e=new URLSearchParams(window.location.search);let t={};for(var i of e.keys())this.config.getUserValue("query")!==i&&(t[i]=e.get(i));return t}buildQuery(e){var t=[];return Object.keys(e).forEach(i=>{t.push(encodeURIComponent(i)+"="+encodeURIComponent(e[i]))}),t.join("&")}}(e),i=new class{constructor(e,t,i){this.http=i,this.cookie=e,this.config=t}get(){return this.cookie.get(this.getCookieName())}exists(){return null!==this.get()}missing(){return!this.exists()}getQueryName(){return this.config.getUserValue("query")}getCookieName(){return this.config.getUserValue("name")}getCookieExpireYears(){return this.config.getUserValue("expireYears")}getFromQuery(){return this.http.getQueryParameter(this.getQueryName())}set(e){this.cookie.set(this.getCookieName(),e,this.getCookieExpireYears())}attempt(){if(this.missing()){let e=this.getFromQuery();if(null===e)return!1;this.set(e)}return!0}}(new class{constructor(){this.context=this.load()}load(){let e={};return document.cookie.split(";").forEach(t=>{let[i,s]=t.split("=");e[i.trim()]=s}),e}get(e){return this.context[e]||null}set(e,t,i){let s=new Date;this.context[e]=t,s.setFullYear(s.getFullYear()+i),document.cookie=e+"="+t+"; expires="+s.toUTCString()+"; path=/; domain="+window.location.hostname+";"}},e,t),s=new class{constructor(e,t,i,s){this.user=e,this.http=i,this.config=t,this.listener=s,this.usedTriggerIds=[]}observe(){this.http.sendRequest("/events","GET",{},t=>{t.forEach(t=>{let i=t.context.parameters;switch(t.context.type){case e.getTriggerValue("pageView"):this.fire(t.id);break;case e.getTriggerValue("click"):[].forEach.call(this.getTargetedElements(i.target),e=>{e.addEventListener("click",()=>this.fire(t.id))});break;case e.getTriggerValue("custom"):this.listener.push(i.identity.name,e=>{this.fire(t.id,e,e=>console.log(e))});break;case e.getTriggerValue("follow"):let s=()=>[].forEach.call(this.getElements("a"),e=>{i.identity.name===e.href&&e.addEventListener("click",i=>{i.preventDefault(),this.fire(t.id,{},()=>window.location=e.href)})});setTimeout(()=>s(),this.config.getValue("timeout"));break;case e.getTriggerValue("videoPlay"):this.observeVideo(t,i,"play");break;case e.getTriggerValue("videoPaused"):this.observeVideo(t,i,"pause");break;case e.getTriggerValue("videoWatched"):this.observeVideo(t,i,"ended");break;case e.getTriggerValue("formSubmit"):let r=()=>[].forEach.call(this.getTargetedElements(i.target,"form"),e=>{e.addEventListener("submit",i=>{let s={};i.preventDefault(),i.stopPropagation(),[].forEach.call(e.getElementsByTagName("input"),e=>{s[e.name]=e.value}),this.fire(t.id,s,()=>e.submit())})});setTimeout(()=>r(),this.config.getValue("timeout"))}}),console.log("Smart Pixel initialized with :n events".replace(":n",t.length))})}observeVideo(e,t,i){let s=()=>[].forEach.call(this.getTargetedElements(t.target,"video"),t=>{t.addEventListener(i,()=>this.fire(e.id))});setTimeout(()=>s(),this.config.getValue("timeout"))}getElements(e){return document.getElementsByTagName(e)}getTargetedElements(t,i="*"){switch(t.type){case e.getTargetValue("none"):return this.getElements(i);case e.getTargetValue("classes"):return document.getElementsByClassName(t.parameters.name);case e.getTargetValue("identifier"):let s=document.getElementById(t.parameters.name);return s?[s]:[]}return[]}fireCustom(e,t={}){this.listener.fire(e,t)}fire(e,t={},i=(()=>{})){if(this.usedTriggerIds.includes(e))return;this.usedTriggerIds.push(e);let s="/events/:triggerId/fire/:contactId".replace(":triggerId",e).replace(":contactId",this.user.get());this.http.sendRequest(s,"POST",t,e=>i(e))}}(i,e,t,new class{constructor(e={}){this.events=e}push(e,t){this.events[e]=t}fire(e,t){if(this.events.hasOwnProperty(e))return this.events[e](t);console.log("Event [:event] not exists".replace(":event",e))}}),r=()=>i.attempt()?s.observe():null;document.readyState?r():document.addEventListener("DOMContentLoaded",()=>r()),window.SPM={user:{get:()=>i.get(),exists:()=>i.exists(),set:e=>i.set(e)},fire:(e,t={})=>s.fireCustom(e,t)}},window.SPM_INIT();